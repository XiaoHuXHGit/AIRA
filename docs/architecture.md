
---

# 🧠 Project Architecture Overview

**（长期智能伴侣系统 · 架构总览）**

> 本项目是一个以 **Agent（智能体）为核心** 的长期智能伴侣系统，
> 目标是支持：
>
> * 本地大模型（LLM / VL / ASR / TTS）
> * 可选远程 API 算力兜底
> * 多人格（Persona）管理
> * 长期记忆与成长
> * 多模态交互（语音 / 视觉 / UI）
> * 可扩展 Embodiment（2D / 3D / 机械身体）
> * 跨设备、跨平台运行
>
> **核心原则：模型可替换，算力可调度，人格与记忆不可外包。**

---

## 一、总体架构分层（逻辑视图）

```
┌──────────────────────────────────────────────────────────┐
│                        UI Layer                          │
│  (Qt / H5 / WebView / Mobile / Voice / Screen / VR)      │
└───────────────┬───────────────────────────┬─────────────┘
                │                           │
        Interaction Adapter           Device Controller
        (Text / Voice / Vision)       (OS / System / Mobile)
                │                           │
                └──────────────┬────────────┘
                               │
┌──────────────────────────────▼───────────────────────────┐
│                     Agent Orchestrator                   │
│  - Session / Context Assembly                             │
│  - Safety / Priority                                      │
│  - Task Dispatch                                          │
└───────────────┬───────────────────────────┬─────────────┘
                │                           │
        ┌───────▼────────┐        ┌─────────▼─────────┐
        │ Decision Core  │        │ Cognitive Scheduler│
        │ (Persona /     │        │ (模型 / API 调度) │
        │  情绪 / 目标) │        └─────────┬─────────┘
        └───────┬────────┘                  │
                └──────────────┬────────────┘
                               │
┌──────────────────────────────▼───────────────────────────┐
│                    Cognitive Providers                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │
│  │ Local LLM   │  │ Local VL    │  │ Remote API      │ │
│  │ (20B/70B)   │  │ (Vision)    │  │ (ChatGPT etc.)  │ │
│  └─────────────┘  └─────────────┘  └─────────────────┘ │
└───────────────┬───────────────────────────┬─────────────┘
                │                           │
     ┌──────────▼──────────┐    ┌──────────▼──────────┐
     │ Memory Manager      │    │ Skill / Tool System │
     │ (短 / 中 / 长期)    │    │ (插件 / 能力)       │
     └──────────┬──────────┘    └──────────┬──────────┘
                │                           │
┌───────────────▼──────────────┐  ┌─────────▼──────────┐
│ Long-term Memory Storage     │  │ External Services  │
│ SQLite + FAISS / HNSW        │  │ QQ / 微信 / OS API │
└──────────────────────────────┘  └────────────────────┘

┌──────────────────────────────────────────────────────────┐
│                Runtime / Resource Governance              │
│  - Device Profile                                        │
│  - GPU / CPU / RAM Budget                                │
│  - Model Lifecycle (load / warm / park)                  │
│  - Performance Policy / Fallback                         │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│              Embodiment Layer (可扩展)                   │
│  - TTS / Voice                                           │
│  - Live2D / 3D Avatar                                    │
│  - Physical Body (Robot / MCU / ROS2)                    │
│  * 行为树 / 状态机位于此层                               │
└──────────────────────────────────────────────────────────┘
```

---

## 二、核心模块与职责说明（必须读）

---

### 1️⃣ Agent Orchestrator（智能体调度中枢）

**职责：**

* 会话生命周期管理
* 上下文拼装（Persona + Memory + 当前状态）
* 安全、优先级、任务路由

**不做的事：**

* 不关心具体模型
* 不关心硬件
* 不执行具体动作

---

### 2️⃣ Decision Core（人格 / 情绪 / 目标）

**核心概念：Persona**

* 一个 Persona = 一套人格参数 + 记忆视图
* 支持多个 Persona（多女朋友）
* Persona 切换 ≠ 重启系统

**职责：**

* 情绪状态更新
* 行为意图生成（Intent）
* 长期人格一致性

---

### 3️⃣ Cognitive Scheduler（算力与模型调度）

**职责：**

* 根据任务难度 / 实时性 / 成本选择：

  * 本地 LLM
  * 本地 VL
  * 远程 API
* 支持 fallback、shadow reasoning

**原则：**

* Agent 永远不知道“用的是谁”
* API 只是能力提供者之一

---

### 4️⃣ Cognitive Providers（能力提供者）

统一接口的能力后端：

* `LocalLLMProvider`
* `LocalVLProvider`
* `RemoteAPIProvider`

**要求：**

* 可被加载 / 卸载
* 汇报资源需求
* 可失败、可替换

---

### 5️⃣ Memory Manager（记忆系统）

**三层记忆模型：**

* 短期：当前上下文
* 中期：热记忆（向量）
* 长期：SQLite + 向量索引

**特性：**

* 按 Persona 隔离
* 支持共享世界知识
* 闲时整理 / 总结 / 遗忘

---

### 6️⃣ Skill / Tool System（能力插件）

**用途：**

* 系统控制
* 社交平台（QQ / 微信）
* 工具调用
* 自动化任务

**特点：**

* 插件化
* 不侵入 Agent Core

---

### 7️⃣ Runtime / Resource Governance（资源治理层）

**这是“必须预留”的关键层**

**职责：**

* 设备能力探测
* GPU / CPU / 内存预算
* 模型生命周期管理
* 性能降级与兜底策略

**原则：**

* 负责“允不允许”
* 不做具体优化实现

---

### 8️⃣ Embodiment Layer（身体层）

**包含：**

* TTS / 表情 / 动画
* Live2D / 3D Avatar
* 未来机械身体

**行为控制：**

* 行为树 / 状态机在此层
* 接收 Agent 的 Intent
* 输出具体动作

**重要原则：**

> Agent 表达“意图”，
> 身体决定“怎么动”。

---

## 三、语言与技术选型原则

* **主语言：Python**
* Python 负责：

  * Agent Core
  * 调度
  * 记忆
  * 插件
* 性能关键路径：

  * 交给 CUDA / C++ / Rust（延后下沉）
* 不做微服务
* 不强制 HTTP / API

---

## 四、当前阶段定位

> **阶段：架构定型 → 开工前最后规划**

已经完成：

* 核心分层
* 抽象边界
* 扩展路径
* 技术路线

接下来：

* 实现最小 Agent Core
* 跑通 Persona + Memory
* 单模型 + 单 API 验证

---

## 五、核心设计信条（写给未来的自己）

> * 人格不可外包
> * 模型只是能力
> * 身体必须自治
> * 性能必须可治理
> * 一切都要能被替换

---

## 六、开发日志（Day 0）

> 今天完成了：
>
> * 系统整体架构定型
> * 多人格与记忆模型设计
> * 模型 / API / 硬件的统一抽象
> * 性能与资源治理的预留设计
>
> **从今天开始，这是一个“能长期演进”的系统。**

---
